<script>
    <?php $this->jQuery()->onLoadCaptureStart();?>
    $('.change-image-quality').attr('checked', true);
    $('#things-new-folder')
            .focus(function () {
                if ($(this).val() == $(this).attr('data-defaultlabel')) {
                    $(this).val('')
                }
            })
            .blur(function () {
                if ($(this).val() == '') {
                    $(this).val($(this).attr('data-defaultlabel'))
                }
            });
    <?php $this->jQuery()->onLoadCaptureEnd();?>
</script>

<div class="seotoaster container">
    <?php echo $this->partial(
        'admin' . DIRECTORY_SEPARATOR . '_header.phtml',
        array('headerText' => 'Upload your files and images', 'helpSection' => $this->helpSection)
    ); ?>
    <div class="grid_12 content">
        <div class="grid_5">
            <?php echo $this->formSelect(
                'things-select-folder',
                (isset($this->currFolder) ? $this->currFolder : null),
                null,
                $this->listFolders
            ); ?>
        </div>
        <span class="grid_2 or"><?php echo $this->translate('OR'); ?></span>

        <div class="grid_5">
            <?php
            $newFolderLabel = $this->translate('create new folder');
            echo $this->formText(
                'things-new-folder',
                null,
                array(
                    'placeholder'       => $newFolderLabel,
                    'data-defaultlabel' => $newFolderLabel
                )
            ); ?>
        </div>
        <div class="grid_6 mt5px image-preview">
            <?php $heddenClass = !empty($this->listPictures) ? '' : 'hidden';?>
            <label id="check-all-label" class="btn link grid_12 alpha omega <?php echo $heddenClass;?>"><input type="checkbox" id="check-all" class="processed hidden"/>[ <?php echo $this->translate('Check all?'); ?> ]</label>
            <div id="filebrowser-images" class="filebrowser-zone list-images media-toaster-uploader-previews grid_12 alpha omega scroll h400px">
                <?php if(!empty($this->listPictures) && !empty($this->picturesPath)):?>
                    <?php foreach ($this->listPictures as $picture):?>
                    <div class="file-container grid_4 alpha">
                        <img title="<?php echo $picture;?>" alt="<?php echo $picture;?>" border="0" src="<?php echo $this->websiteUrl . $this->picturesPath . $picture;?>">
                        <input type="checkbox" class="toremove hidden" name="removeImages[]" value="<?php echo $picture;?>" />
                    </div>
                    <?php endforeach;?>
                <?php endif;?>
            </div>
            <div class="deleteBtnBlock grid_12 mt5px alpha omega <?php echo $heddenClass;?>">
                <button id="deleteBtn" class="btn block error"><?php echo $this->translate('Delete Selected');?></button>
            </div>
        </div>
        <div class="grid_6 mt20px mb15px">
            <?php
            $thingsUploader = $this->toasterUploader(
                array(
                    'id'      => 'media-toaster-uploader',
                    'type'    => 'dragdrop',
                    'caption' => $this->translate('Drag & drop files here'),
                    'caller'  => 'media'
                )
            );
            echo $thingsUploader;
            ?>
            <label class="fl-right mt15px pointer"><input type="checkbox" name="change-image-quality"
                                                          class="change-image-quality"
                                                          value="0"/> <?php echo $this->translate(
                    'Optimize image size.'
                ); ?></label>
            <!--div class="grid_12 seo-tip">
			<strong><?php echo $this->translate('SEO tip'); ?></strong>: <?php echo $this->translate('Have you thought about  meaningfully naming your images files after your keywords');?>?
		</div-->
            <div id="media-toaster-uploader-filelist" class="grid_12 alpha omega ui-widget-content scroll mt10px h300px">
                <?php echo $this->translate('Upload progress will appear here.'); ?>
            </div>
        </div>
        <input type="hidden" class="secureToken" name="secureToken" value="<?php echo $this->secureToken;?>">
    </div>
</div>
<script>
    var btnCheckAll = $('#check-all'),
        btnDelete   = $('#deleteBtn');

    btnCheckAll.button();
    btnDelete.button();

    $(document).on('toggleActive', '.file-container', function() {
        var $flag   = $(this).children('input.toremove');
        var $parent = $(this).parent('.filebrowser-zone');

        if ($flag.prop('checked')){
            $flag.prop('checked', false);
            $(this).removeClass('active');
            if ($parent.find('.active').size() < $parent.find('.file-container').size() ) {
                $('#check-all').prop('checked', false);
                $(this).css({'background': ''});
                $(this).find('img').css({'opacity': ''});
            }
        } else {
            $(this).addClass('active').css({'background': 'rgba(231,76,60,.2)'});
            $(this).find('img').css({'opacity': '0.5'});
            $flag.prop('checked', true);
            if ($parent.find('.file-container:not(.active)').size() === 0){
                btnCheckAll.prop('checked', true);
            }
        }
        btnCheckAll.button('refresh');
    }).on('click', '.file-container', function() {
        $(this).trigger('toggleActive');
    }).on('click', '.file-container > input.toremove', function(event) {
        $(this).parent('.file-container').trigger('toggleActive');
    });

    $(document).on('change', '#check-all', function() {
        var notActive = $('.file-container:not(.active)');
        var active = $('.file-container.active');

        if (notActive.size()){
            notActive.trigger('toggleActive');
        }else if(active.size()){
            active.trigger('toggleActive');
        }
    });

    $('#check-all-label').bind('click', function() {
        $('#check-all').trigger('change');
    });

    $('#things-select-folder').change(function(){
        $('.filebrowser-zone').html('');

        $('.counter').text('');

        if ($(this).val() == 0){
            $('#check-all-label').addClass('hidden');
            $('.deleteBtnBlock').addClass('hidden');
            return false;
        }

        $('#check-all:checked').prop('checked', false);

        $.ajax({
            url: '<?php echo $this->websiteUrl;?>/backend/backend_media/getdirectorycontent/',
            type: 'post',
            data: {'folder': $(this).val()},
            dataType: 'json',
            beforeSend: function(){
                showSpinner()
            },
            complete: function(){
                hideSpinner()
            },
            success: function(response){
                var imgPreview = '';
                if(response.imageList.length != 0){
                    $('.file-container').empty();
                    $('#check-all-label').removeClass('hidden');
                    $('.deleteBtnBlock').removeClass('hidden');

                    var imageList = response.imageList;
                    $.each(imageList, function(i, val) {
                        imgPreview += '<div class="file-container grid_4 alpha"> ' +
                            '<img title="'+ val.name +'" alt="'+ val.name +'" border="0" src="'+ val.src +'"> ' +
                            '<input type="checkbox" class="toremove hidden" name="removeImages[]" value="'+ val.name +'"> ' +
                            '</div>';
                    });
                    $('#filebrowser-images').append(imgPreview);
                }
                hideSpinner();
            }
        });
    });

    $(document).on('click', '#deleteBtn', function(e) {
        e.preventDefault();
        var imagesBlock = $('#filebrowser-images');
        if ($('#things-select-folder').val() === '0') {
            showMessage('<?php echo $this->translate("No folder specified");?>', true, 5000);
            return false;
        }

        if (imagesBlock.find('input.toremove:checked').size() == 0) {
            showMessage('<?php echo $this->translate("Nothing to remove");?>', true, 5000);
            return false;
        }

        var images = imagesBlock.find('input.toremove:checked');
        var imagesArr = [];
        if(images.size() != 0){
            $(images).each(function(index, el) {
                var img = el.value;
                imagesArr.push(img);
            });
        }

        $.ajax({
            url: '<?php echo $this->websiteUrl;?>/backend/backend_media/removefile/',
            type: 'post',
            data: {'folder': $('#things-select-folder').val(),'removeImages': imagesArr, 'secureToken': $('.secureToken').val()},
            dataType: 'json',
            beforeSend: function(){
                showSpinner()
            },
            complete: function(){
                hideSpinner()
            },
            success: function(response) {
                if (response.hasOwnProperty('deleted') && response.deleted.length > 0) {
                    var removedFiles = [];
                    for (var i in response.deleted) {
                        $('#filebrowser-images').queue(function(next){
                            $('.file-container:has(input.toremove:checked[value="'+response.deleted[i]+'"])').remove();
                            next();
                        });
                    }
                }
                if (response.hasOwnProperty('folderRemoved')) {
                    if (response.folderRemoved === true){
                        $('#check-all-label').addClass('hidden');
                        $('.deleteBtnBlock').addClass('hidden');
                        $('#things-select-folder').find('option:selected').remove().end().val('0');
                    }
                }
            }
        });
    });
</script>